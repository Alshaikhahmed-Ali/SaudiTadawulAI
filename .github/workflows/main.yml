import os
import requests
import sys
import time

# --- ุงุณุชุฏุนุงุก ุงูููุงุชูุญ ูู ุงูุฎุฒูุฉ ---
GEMINI_KEY = os.environ.get("GEMINI_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
URL = os.environ.get("CSV_URL")

# ุฏุงูุฉ ุงูุฅุฑุณุงู ูุชููุฌุฑุงู
def send_telegram(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text, "parse_mode": "Markdown"}
    try:
        requests.post(url, data=payload, timeout=10)
    except:
        pass

# ุฏุงูุฉ ุงูุชุญููู ุงูุฑุฆูุณูุฉ
def run_saudi_analyzer():
    try:
        print("๐ฅ ุฌุงุฑู ุณุญุจ ุจูุงูุงุช ุงูุณูู ุงูุณุนูุฏู (ุชุฏุงูู)...")
        headers = {'User-Agent': 'Mozilla/5.0'}
        response = requests.get(URL, headers=headers, timeout=30)
        raw_text = response.text.strip()
        
        # ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช
        if not raw_text or "No stocks found" in raw_text:
            send_telegram("๐ **ูุงุณุญ ุงูุณูู ุงูุณุนูุฏู**\n\nูู ูุชู ุงูุนุซูุฑ ุนูู ูุฑุต ุชุทุงุจู ุงูููุชุฑ ุงูููู ุงูููู.")
            return

        print("๐ค ุฌุงุฑู ุงูุงุชุตุงู ุจุงููุญูู ุงููุงูู (Gemini)...")
        
        # ุงุณุชุฎุฏุงู ููุฏูู Flash Latest ุงููุณุชูุฑ ูุงูููู
        gemini_endpoint = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key={GEMINI_KEY}"
        
        # --- ุงูุจุฑููุจุช (ุงูุชุนูููุฉ) ุงูุนุฑุจูุฉ ---
        prompt = f"""
        ุฃูุช ูุญูู ูุงูู ุฎุจูุฑ ูู ุณูู ุงูุฃุณูู ุงูุณุนูุฏู (ุชุฏุงูู - TASI).
        ูุฏูู ุงูุจูุงูุงุช ุงููููุฉ ุงูุฎุงู ุงูุชุงููุฉ ูุฃุณูู ุชู ููุชุฑุชูุง ุจูุงุกู ุนูู ูุคุดุฑุงุช ูููุฉ:
        {raw_text}

        ุงููุทููุจ ููู:
        1. ุงุฎุชุฑ ุฃูุถู 3 ุฃุณูู ูุงุนุฏุฉ ูููุงู ููููู ุจูุงุกู ุนูู ุงูุฒุฎู ูุงูุณูููุฉ.
        2. ุงูุชุจ ุชูุฑูุฑุงู ุงุญุชุฑุงููุงู ูุฎุชุตุฑุงู ุจุงูููุฌุฉ ุงููุงููุฉ ุงูุณุนูุฏูุฉ.
        3. ุงูุชุฒู ุชูุงูุงู ุจูุฐุง ุงููุงูุจ (ูุง ุชุบูุฑ ุงูุชูุณูู):

        ๐ธ๐ฆ **ุชูุฑูุฑ ุชุฏุงูู ุงูุฐูู ุงููููู** ๐ธ๐ฆ

        ๐ **[ุงุณู ุงูุณูู] (ุงูุฑูุฒ)** - ุงูุณุนุฑ: [ุงูุณุนุฑ ุงูุญุงูู] ุฑูุงู
        ๐ **ุงููุธุฑุฉ ุงููููุฉ:** [ุฌููุฉ ูุงุญุฏุฉ ูููุฉุ ูุซู: ุงุฎุชุฑุงู ููุงููุฉ ุชุงุฑูุฎูุฉุ ุชูุงุทุน ุฅูุฌุงุจู ูููุงูุฏุ ุณูููุฉ ุดุฑุงุฆูุฉ ุนุงููุฉ]
        ๐ฏ **ุงูุฎุทุฉ ุงูููุชุฑุญุฉ:**
        โข ุงูุฏุฎูู: [ููุทูุฉ ุงูุณุนุฑ ุงูุญุงููุฉ]
        โข ุงููุฏู: [ุณุนุฑ ูุณุชูุฏู ููุทูู ูุฑูุจ]
        โข ุงูููู: [ูุณุฑ ุณุนุฑ ูุฐุง]
        
        ---
        โ๏ธ *ุฅุฎูุงุก ูุณุคูููุฉ: ูุฐุง ุชุญููู ููู ุขูู ุจูุงุณุทุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ ูููุณ ุฏุนูุฉ ููุฒูุฉ ููุจูุน ุฃู ุงูุดุฑุงุก. ูุฑุงุฑู ุงูุงุณุชุซูุงุฑู ูุณุคูููุชู ูุญุฏู.*
        """

        payload = {
            "contents": [{"parts": [{"text": prompt}]}]
        }
        
        headers_gemini = {'Content-Type': 'application/json'}
        g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=30)
        
        # ุงูุชุนุงูู ูุน ุถุบุท ุงูุทูุจุงุช (Retry Logic)
        if g_res.status_code == 429:
            print("โณ ุถุบุท ุนูู ุงูุดุจูุฉุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ 20 ุซุงููุฉ...")
            time.sleep(20)
            g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=30)

        if g_res.status_code != 200:
            error_msg = g_res.text
            print(f"โ Gemini Error: {error_msg}")
            send_telegram(f"โ๏ธ **ุฎุทุฃ ุชููู:**\n`{error_msg[:200]}`")
            sys.exit(1)

        analysis = g_res.json()['candidates'][0]['content']['parts'][0]['text']
        
        # ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงูููุงุฆู
        send_telegram(analysis)
        print("โ ุชู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงูุณุนูุฏู ุจูุฌุงุญ!")

    except Exception as e:
        print(f"๐ฅ ุฎุทุฃ ุบูุฑ ูุชููุน: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    run_saudi_analyzer()

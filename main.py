import os
import requests
import sys
import time
import csv
import io

# --- ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุจูุงูุงุช ุงูุดุฑูุงุช ูู ุงูููู ุงูุฎุงุฑุฌู ---
# ุชุฃูุฏ ุฃู ููู companies.py ููุฌูุฏ ูู ููุณ ุงููุฌูุฏ
try:
    from companies import tadawul_map
except ImportError:
    # ุงุญุชูุงุท ูู ุญุงู ูุณูุงู ุงููููุ ูุณุชุฎุฏู ูุงููุณ ูุงุฑุบ
    tadawul_map = {}

# --- ุงูุฅุนุฏุงุฏุงุช ---
GEMINI_KEY = os.environ.get("GEMINI_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
URL = os.environ.get("CSV_URL")

def get_arabic_name(symbol):
    """ุฏุงูุฉ ุชุณุชุฎุฑุฌ ุงูุงุณู ุงูุนุฑุจู ูู ุงููุงููุณ ุงููุณุชูุฑุฏ"""
    # ุชูุธูู ุงูุฑูุฒ ูู ุฃู ุฅุถุงูุงุช ูุซู .SR
    clean_symbol = str(symbol).replace('.SR', '').strip()
    
    # ุงูุจุญุซ ูู ุงููุงููุณ
    name = tadawul_map.get(clean_symbol)
    
    # ุฅุฐุง ูู ูุฌุฏ ุงูุงุณู ูู ุงููุงููุณุ ูุนูุฏ ุงูุฑูุฒ ููุณู
    if not name:
        return f"ุดุฑูุฉ ({clean_symbol})"
    return name

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text, "parse_mode": "Markdown"}
    try:
        requests.post(url, data=payload, timeout=30)
    except:
        pass

def run_saudi_analyzer():
    try:
        print("๐ฅ ุฌุงุฑู ุณุญุจ ุจูุงูุงุช ุงูุณูู ุงูุณุนูุฏู...")
        response = requests.get(URL, timeout=60)
        
        if response.status_code != 200:
            send_telegram(f"โ๏ธ ุฎุทุฃ ูู ุงููุตุฏุฑ: {response.status_code}")
            return

        csv_text = response.text.strip()

        if not csv_text or len(csv_text) < 10: 
            send_telegram("๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู:**\nูุง ุชูุฌุฏ ุฃุณูู ุชุทุงุจู ุงูููุชุฑ ุญุงููุงู.")
            return

        # --- ุงููุนุงูุฌุฉ ุงูุฐููุฉ ููุจูุงูุงุช ---
        print("โ๏ธ ุฌุงุฑู ูุนุงูุฌุฉ ุงูุจูุงูุงุช ูุงุณุชุจุฏุงู ุงูุฃุณูุงุก ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...")
        
        processed_rows = []
        csv_reader = csv.reader(io.StringIO(csv_text))
        
        header = next(csv_reader, None)
        
        for row in csv_reader:
            if len(row) > 0:
                symbol = row[0]
                # ููุง ูุณุชุฎุฏู ุงูุฏุงูุฉ ุงูุชู ุชูุฑุฃ ูู ุงูููู ุงูุฎุงุฑุฌู
                arabic_name = get_arabic_name(symbol)
                
                # ุชุฌููุฒ ุงูุณุทุฑ ููุฐูุงุก ุงูุงุตุทูุงุนู
                # ูุฑุณู ูู: ุงูุงุณู ุงูุนุฑุจู ุงูุฌุงูุฒ + ุจุงูู ุงูุจูุงูุงุช
                row_str = f"ุงูุงุณู ุงูุนุฑุจู: {arabic_name}, ุงูุฑูุฒ: {symbol}, ุจูุงูุงุช: {','.join(row[1:])}"
                processed_rows.append(row_str)

        final_data_for_ai = "\n".join(processed_rows)

        print("๐ค ุฌุงุฑู ุงูุฅุฑุณุงู ูููุญูู ุงูุฐูู...")
        
        gemini_endpoint = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key={GEMINI_KEY}"
        
        prompt = f"""
        ุฃูุช "ููุงุต ุงูุณูู ุงูุณุนูุฏู"ุ ูุญูู ููู ูุญุชุฑู.
        ูุฏูู ูุงุฆูุฉ ุจูุฑุต ุงุณุชุซูุงุฑูุฉ ุชู ุงุณุชุจุฏุงู ุฑููุฒูุง ุจุงูุฃุณูุงุก ุงูุนุฑุจูุฉ ุงูุตุญูุญุฉ:
        
        ```text
        {final_data_for_ai}
        ```

        ุงููุทููุจ ููู ุจุฏูุฉ:
        1. **ุงูุงุฎุชูุงุฑ:** ุงุฎุชุฑ ุฃูุถู 5 ูุฑุต ุฅูุฌุงุจูุฉ ูู ุงููุงุฆูุฉ ุฃุนูุงู.
        2. **ุงูุฃุณูุงุก:** ุงุณุชุฎุฏู "ุงูุงุณู ุงูุนุฑุจู" ุงูููุชูุจ ูู ุงูุจูุงูุงุช ููุง ูู ุชูุงูุงู.
        3. **ุงูุฅูููุฌู:** ุถุน ุฅูููุฌู ูุทุงุน ููุงุณุจ ุจุฌุงูุจ ูู ุงุณู (ูุซูุงู: ๐ฅ ููุตุญุฉุ ๐ฆ ููุจูููุ ๐๏ธ ููุจูุงุกุ โฝ ููุทุงูุฉ).
        4. **ุงูุชูุณูู:** ุงูุชุฒู ุจูุฐุง ุงููุงูุจ ูุตูุงู:

        ๐ฆ๐ธ๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู (AI)** ๐ธ๐ฆ๐ฆ
        ุชูุฑูุฑ ููู ูุฑุตุฏ ุฃููู ุงููุฑุต ุงููุญุธูุฉ:

        1๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุฅูููุฌู] ([ุงูุฑูุฒ])
           ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
           ๐ ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ ููุดูู]
           ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]

        2๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุฅูููุฌู] ([ุงูุฑูุฒ])
           ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
           ๐ ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
           ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]

        3๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุฅูููุฌู] ([ุงูุฑูุฒ])
           ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
           ๐ ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
           ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]

        4๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุฅูููุฌู] ([ุงูุฑูุฒ])
           ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
           ๐ ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
           ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]

        5๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุฅูููุฌู] ([ุงูุฑูุฒ])
           ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
           ๐ ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
           ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]

        ๐ **ููุงุญุธุฉ ูููุฉ:** ุชู ุงุณุชุจุนุงุฏ ุณูู [ุงุณู] ([ุงูุฑูุฒ]) ุจุณุจุจ [ุณุจุจ ุณูุจู].

        ๐ด **ุฅุฎูุงุก ูุณุคูููุฉ:** ูุฐู ูุฑุงุกุฉ ูููุฉ ุขููุฉ ูููุณุช ุชูุตูุฉ ูุงููุฉ ููุฒูุฉ. ูุฑุงุฑ ุงูุจูุน ูุงูุดุฑุงุก ูุณุคูููุชู ูุญุฏู.
        โฆ
        โฆ
        """

        payload = {
            "contents": [{"parts": [{"text": prompt}]}]
        }
        
        headers_gemini = {'Content-Type': 'application/json'}
        g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)
        
        if g_res.status_code == 429 or g_res.status_code == 500:
            time.sleep(10)
            g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)

        if g_res.status_code != 200:
            sys.exit(1)

        analysis = g_res.json()['candidates'][0]['content']['parts'][0]['text']
        send_telegram(analysis)
        print("โ ุชู ุงูุฅุฑุณุงู ุจุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฎุงุฑุฌูุฉ!")

    except Exception as e:
        print(f"๐ฅ Error: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    run_saudi_analyzer()

import os
import requests
import sys
import time
import csv
import io
import re  # ููุชุจุฉ ููุจุญุซ ุนู ุงูุฃุฑูุงู ุฏุงุฎู ุงููุตูุต

# --- ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ---
try:
    from companies import tadawul_map
except ImportError:
    tadawul_map = {}

# --- ุงูุฅุนุฏุงุฏุงุช ---
GEMINI_KEY = os.environ.get("GEMINI_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
URL = os.environ.get("CSV_URL")

def get_clean_data(raw_text):
    """
    ุฏุงูุฉ ุฐููุฉ ุชุณุชุฎุฑุฌ ุงูุฑูุฒ (4 ุฃุฑูุงู) ูุชุฌูุจ ุงูุงุณู ุงูุนุฑุจู
    ุญุชู ูู ูุงูุช ุงูุจูุงูุงุช ูููุซุฉ ูุซู '4291.SA|129.00'
    """
    # ุงูุจุญุซ ุนู ุฃู 4 ุฃุฑูุงู ูุชุชุงููุฉ ูู ุงููุต (ููู ุฑูุฒ ุงูุดุฑูุฉ)
    match = re.search(r'(\d{4})', str(raw_text))
    
    if match:
        clean_symbol = match.group(1) # ุงุณุชุฎุฑุงุฌ ุงูุฑูู ููุท (ูุซูุงู 4291)
        arabic_name = tadawul_map.get(clean_symbol, "ุณูู ุดุฑูุฉ") # ุงูุจุญุซ ูู ุงููุงููุณ
        return clean_symbol, arabic_name
    
    return raw_text, "ุณูู"

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text, "parse_mode": "Markdown"}
    try:
        requests.post(url, data=payload, timeout=30)
    except:
        pass

def run_saudi_analyzer():
    try:
        print("๐ฅ ุฌุงุฑู ุณุญุจ ุจูุงูุงุช ุงูุณูู ุงูุณุนูุฏู...")
        response = requests.get(URL, timeout=60)
        
        if response.status_code != 200:
            send_telegram(f"โ๏ธ ุฎุทุฃ ูู ุงููุตุฏุฑ: {response.status_code}")
            return

        csv_text = response.text.strip()

        if not csv_text or len(csv_text) < 10: 
            send_telegram("๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู:**\nูุง ุชูุฌุฏ ุฃุณูู ุชุทุงุจู ุงูููุชุฑ ุญุงููุงู.")
            return

        print("โ๏ธ ุฌุงุฑู ุชูุธูู ุงูุจูุงูุงุช ูุงุณุชุจุฏุงู ุงูุฑููุฒ...")
        
        processed_rows = []
        # ูุฑุงุกุฉ ุงูููู ุณุทุฑ ุณุทุฑ
        lines = csv_text.split('\n')
        
        # ุชุฎุทู ุฃูู ุณุทุฑ (ุงูุชุฑููุณุฉ) ุฅุฐุง ูุงู ูุญุชูู ุนูู ูููุงุช ุฅูุฌููุฒูุฉ
        if "Symbol" in lines[0] or "Ticker" in lines[0]:
            lines = lines[1:]

        for line in lines:
            if len(line) > 5: # ุชุฌุงูู ุงูุฃุณุทุฑ ุงููุงุฑุบุฉ
                # ุงุณุชุฎุฑุงุฌ ุงูุฑูุฒ ูุงูุงุณู ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฐููุฉ
                symbol, arabic_name = get_clean_data(line)
                
                # ุชุฌููุฒ ุงูุณุทุฑ ููุฐูุงุก ุงูุงุตุทูุงุนู ุจุดูู ูุธูู ุฌุฏุงู
                # ูุฑุณู ูู: "ูุงุฏู (6010) - ุจูุงูุงุช: ..."
                row_str = f"ุงูุดุฑูุฉ: {arabic_name} ({symbol}) | ุงูุจูุงูุงุช ุงูุฎุงู: {line}"
                processed_rows.append(row_str)

        final_data_for_ai = "\n".join(processed_rows)

        print("๐ค ุฌุงุฑู ุงูุฅุฑุณุงู ูููุญูู ุงูุฐูู...")
        
        gemini_endpoint = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key={GEMINI_KEY}"
        
        prompt = f"""
        ุฃูุช "ููุงุต ุงูุณูู ุงูุณุนูุฏู"ุ ูุญูู ููู ุฎุจูุฑ.
        ูุฏูู ุงูุจูุงูุงุช ุงูุชุงููุฉ (ุชู ุชูุธูู ุงูุฃุณูุงุก ุงูุนุฑุจูุฉ ูู):
        
        ```text
        {final_data_for_ai}
        ```

        ุงููุทููุจ ููู ุจุฏูุฉ ูุชูุงููุฉ:
        1. **ุงูุชูุธูู:** ุชุฌุงูู ุงูุฃุฑูุงู ุงูุบุฑูุจุฉ ุฃู ุงูุชูุงุฑูุฎ ุงูููุฌูุฏุฉ ูู ุงูุจูุงูุงุช ุงูุฎุงู. ุฑูุฒ ุนูู ุงูุณุนุฑ ูุงููุคุดุฑุงุช.
        2. **ุงูุงุฎุชูุงุฑ:** ุงุฎุชุฑ ุฃูุถู 4 ุฃู 5 ูุฑุต ุฅูุฌุงุจูุฉ.
        3. **ุงูุฅูููุฌู:** ุถุน ุฅูููุฌู *ูุงุญุฏ* ูุนุจุฑ ุจุฌุงูุจ ุงุณู ูู ุดุฑูุฉ (ูุซุงู: ๐ฅ ููุงุฏูุ ๐ซ ูููุทููุฉ ููุชุนูููุ ๐ฅ ููุทุจูุฉ).
        4. **ุงูุชูุณูู:** ุงูุชุฒู ุจูุฐุง ุงููุงูุจ ุงูุฌูุงูู (ุจุฏูู ุชุบููุฑ):

        ๐ฆ๐ธ๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู (AI)** ๐ธ๐ฆ๐ฆ
        *ุชูุฑูุฑ ุงููุฑุต ุงููุญุธูุฉ*

        1๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุงูุฅูููุฌู] ([ุงูุฑูุฒ])
        ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ ุงูุญุงูู] ุฑูุงู
        ๐ ุงูุชุญููู: [ุฌููุฉ ูููุฉ ูุงุญุฏุฉ ุฐููุฉ ููุฎุชุตุฑุฉ]
        ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]
        ูููููููููููููููููููููููููููููููููููููููููููููููู

        2๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุงูุฅูููุฌู] ([ุงูุฑูุฒ])
        ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ ุงูุญุงูู] ุฑูุงู
        ๐ ุงูุชุญููู: [ุฌููุฉ ูููุฉ ูุงุญุฏุฉ ุฐููุฉ ููุฎุชุตุฑุฉ]
        ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]
        ูููููููููููููููููููููููููููููููููููููููููููููููู

        3๏ธโฃ **[ุงูุงุณู ุงูุนุฑุจู]** [ุงูุฅูููุฌู] ([ุงูุฑูุฒ])
        ๐ฐ ุงูุณุนุฑ: [ุงูุณุนุฑ ุงูุญุงูู] ุฑูุงู
        ๐ ุงูุชุญููู: [ุฌููุฉ ูููุฉ ูุงุญุฏุฉ ุฐููุฉ ููุฎุชุตุฑุฉ]
        ๐ฏ ูุฏู: [ุงููุฏู] | ๐ก๏ธ ููู: [ุงูููู]
        ูููููููููููููููููููููููููููููููููููููููููููููููู

        *(ูุฑุฑ ููุจููุฉ...)*

        ๐ **ููุงุญุธุฉ:** ุชู ุงุณุชุจุนุงุฏ ุณูู [ุงูุงุณู] ูุงุฑุชูุงุน ุงูุชุฐุจุฐุจ.

        ๐ด **ุชูููู:** ูุฑุงุกุฉ ูููุฉ ุขููุฉ ูููุณุช ุชูุตูุฉ ูุงููุฉ. ุงููุฑุงุฑ ูุณุคูููุชู.
        โฆ
        """

        payload = {
            "contents": [{"parts": [{"text": prompt}]}]
        }
        
        headers_gemini = {'Content-Type': 'application/json'}
        g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)
        
        if g_res.status_code == 429 or g_res.status_code == 500:
            time.sleep(10)
            g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)

        if g_res.status_code != 200:
            sys.exit(1)

        analysis = g_res.json()['candidates'][0]['content']['parts'][0]['text']
        send_telegram(analysis)
        print("โ ุชู ุงูุฅุฑุณุงู ุจุงูุชูุณูู ุงููุตุญุญ ูุงููุธูู!")

    except Exception as e:
        print(f"๐ฅ Error: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    run_saudi_analyzer()

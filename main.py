import os
import requests
import sys
import time

# --- ุงูุฅุนุฏุงุฏุงุช ---
GEMINI_KEY = os.environ.get("GEMINI_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
URL = os.environ.get("CSV_URL")

def send_telegram(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text, "parse_mode": "Markdown"}
    try:
        requests.post(url, data=payload, timeout=30)
    except:
        pass

def run_saudi_analyzer():
    try:
        print("๐ฅ ุฌุงุฑู ุณุญุจ ุจูุงูุงุช ุงูุณูู ุงูุณุนูุฏู...")
        response = requests.get(URL, timeout=60)
        
        if response.status_code != 200:
            send_telegram(f"โ๏ธ ุฎุทุฃ ูู ุงููุตุฏุฑ: {response.status_code}")
            return

        csv_data = response.text.strip()

        if not csv_data or len(csv_data) < 10: 
            send_telegram("๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู:**\nูุง ุชูุฌุฏ ุฃุณูู ุชุทุงุจู ุงูููุชุฑ ุญุงููุงู.")
            return

        print("๐ค ุฌุงุฑู ุงูุชุญูููุ ุชุตุญูุญ ุงูุฃุณูุงุกุ ูุฅุถุงูุฉ ุงูุฅูููุฌู...")
        
        gemini_endpoint = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key={GEMINI_KEY}"
        
        prompt = f"""
        ุฃูุช ุฎุจูุฑ ูุญุชุฑู ูู ุงูุณูู ุงูุณุนูุฏู (ุชุฏุงูู).
        ูุฏูู ุงูุจูุงูุงุช ุงูุชุงููุฉ (CSV):
        ```csv
        {csv_data}
        ```

        ุงูุชุนูููุงุช ุงููุทููุจุฉ ููู ุจุฏูุฉ:
        
        1. **ุชุตุญูุญ ุงูุฃุณูุงุก (ุฃููููุฉ ูุตูู):**
           - ุชุฌุงูู ุงูุงุณู ุงูุฅูุฌููุฒู ุงูููุฌูุฏ ูู ุงูููู ูุฃูู ูุฏ ูููู ูุฎุชุตุฑุงู.
           - ุงูุธุฑ ุฅูู **ุงูุฑูุฒ ุงูุฑููู (Symbol/Code)** ููุท.
           - ุงุณุชุฎุฑุฌ ุงูุงุณู ุงูุนุฑุจู ุงูุฑุณูู ุงูุดุงุฆุน ููุฐุง ุงูุฑูุฒ ูู ุฐุงูุฑุชู (ูุซุงู: 1120 -> ุงูุฑุงุฌุญูุ 2010 -> ุณุงุจูุ 4030 -> ุงูุจุญุฑู).

        2. **ุฅุถุงูุฉ ุงูุฑูุญ (ุงูุฅูููุฌู):**
           - ุถุน ุฅูููุฌู ูุงุญุฏ ูุนุจุฑ ุจุฌุงูุจ ุงุณู ูู ุดุฑูุฉ ูุฏู ุนูู ูุทุงุนูุง.
           - ุฃูุซูุฉ: (๐ฆ ููุจูููุ ๐ข๏ธ ููุจุชุฑููููุงููุงุช ูุงูุทุงูุฉุ ๐๏ธ ููุฃุณููุช ูุงูุจูุงุกุ ๐ฅ ููุตุญุฉุ ๐ฑ ููุงุชุตุงูุงุชุ ๐ก๏ธ ููุชุฃูููุ ๐ฅ ููุฃุบุฐูุฉ).

        3. **ุงูุงุฎุชูุงุฑ:** ุงุฎุชุฑ ุฃูุถู 5 ูุฑุต ุฅูุฌุงุจูุฉ ูููุงู.
        
        4. **ุงูุชุญุฐูุฑ:** ุงุฎุชุฑ ุณููุงู ุณูุจูุงู/ูุชุถุฎูุงู ููููุงุญุธุฉ (ุฅู ูุฌุฏ).

        5. **ุงูุชูุณูู:** ุงูุชุฒู ุจูุฐุง ุงููุงูุจ ูุตูุงู (ูุน ุฅุถุงูุฉ ุงูุฅูููุฌู ูุงูุดุนุงุฑ ุงูุฌุฏูุฏ):

        ๐ฆ๐ธ๐ฆ **ููุงุต ุงูุณูู ุงูุณุนูุฏู (AI)** ๐ธ๐ฆ๐ฆ
        ุชูุฑูุฑ ููู ุขูู ูุฑุตุฏ ุงููุฑุต ุงูุฅูุฌุงุจูุฉ ุจูุงุกู ุนูู ุงููุคุดุฑุงุช ุงููุญุธูุฉ.

        โข ุณูู [ุงูุงุณู ุงูุนุฑุจู] [ุฅูููุฌู ุงููุทุงุน] ([ุงูุฑูุฒ])
          ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
          ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ ุฌุฏุงู ููุดูู]
          ๐ฏ ุงููุฏู: [ูุฏู] | ๐ก๏ธ ุงูููู: [ููู]

        โข ุณูู [ุงูุงุณู ุงูุนุฑุจู] [ุฅูููุฌู ุงููุทุงุน] ([ุงูุฑูุฒ])
          ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
          ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
          ๐ฏ ุงููุฏู: [ูุฏู] | ๐ก๏ธ ุงูููู: [ููู]

        โข ุณูู [ุงูุงุณู ุงูุนุฑุจู] [ุฅูููุฌู ุงููุทุงุน] ([ุงูุฑูุฒ])
          ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
          ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
          ๐ฏ ุงููุฏู: [ูุฏู] | ๐ก๏ธ ุงูููู: [ููู]

        โข ุณูู [ุงูุงุณู ุงูุนุฑุจู] [ุฅูููุฌู ุงููุทุงุน] ([ุงูุฑูุฒ])
          ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
          ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
          ๐ฏ ุงููุฏู: [ูุฏู] | ๐ก๏ธ ุงูููู: [ููู]

        โข ุณูู [ุงูุงุณู ุงูุนุฑุจู] [ุฅูููุฌู ุงููุทุงุน] ([ุงูุฑูุฒ])
          ุงูุณุนุฑ: [ุงูุณุนุฑ] ุฑูุงู
          ุงูุชุญููู: [ุณุจุจ ููู ูุฎุชุตุฑ]
          ๐ฏ ุงููุฏู: [ูุฏู] | ๐ก๏ธ ุงูููู: [ููู]

        ๐ **ููุงุญุธุฉ:** ุชู ุงุณุชุจุนุงุฏ ุณูู [ุงูุงุณู] ([ุงูุฑูุฒ]) ูุงุฑุชูุงุน ูุฎุงุทุฑู ุงููููุฉ.

        ๐ด **ุชูููู ูุงู:** ูุฐู ุงูุฑุณุงูุฉ ูุฑุงุกุฉ ูููุฉ ุขููุฉ ูููุณุช ุชูุตูุฉ ูุงููุฉ ููุฒูุฉ ุจุงูุจูุน ุฃู ุงูุดุฑุงุก. ุงููุฑุงุฑ ุงูุงุณุชุซูุงุฑู ูุณุคูููุชู ุงููุงููุฉ.
        โฆ
        โฆ
        โฆ
        """

        payload = {
            "contents": [{"parts": [{"text": prompt}]}]
        }
        
        headers_gemini = {'Content-Type': 'application/json'}
        
        # ูููุฉ ุฏูููุชูู ูุถูุงู ุฏูุฉ ุงูุฃุณูุงุก ูุงูุฅูููุฌู
        g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)
        
        if g_res.status_code == 429 or g_res.status_code == 500:
            time.sleep(10)
            g_res = requests.post(gemini_endpoint, json=payload, headers=headers_gemini, timeout=120)

        if g_res.status_code != 200:
            sys.exit(1)

        analysis = g_res.json()['candidates'][0]['content']['parts'][0]['text']
        send_telegram(analysis)
        print("โ ุชู ุงูุฅุฑุณุงู ุจุงูุดูู ุงูุฌุฏูุฏ!")

    except Exception as e:
        print(f"๐ฅ Error: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    run_saudi_analyzer()
